<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.uxiangtech.activitybox.data.prop.PropUserDAO">

  <sql id="fields">
    `id`,
    `activity_id`,
    `user_id`,
    `prop_id`,
    `quantity`,
    `is_deleted`,
    `gmt_create`,
    `gmt_modified`
  </sql>

  <insert id="insertOrAddQuantity">
    INSERT INTO `t_prop_user` (`activity_id`, `user_id`, `prop_id`, `quantity`)
    VALUES (#{activityId}, #{userId}, #{propId}, #{quantity})
    ON DUPLICATE KEY UPDATE `quantity` = `quantity` + #{quantity}
  </insert>

  <update id="subQuantity">
    UPDATE `t_prop_user`
    SET `quantity` = `quantity` - #{quantity}
    WHERE `user_id` = #{userId} AND `activity_id` = #{activityId} AND `prop_id` = #{propId} AND `quantity` >= #{quantity}
  </update>

  <select id="countPropQuantity" resultType="java.lang.Long">
    SELECT `quantity`
    FROM `t_prop_user`
    WHERE `user_id` = #{userId} AND `activity_id` = #{activityId} AND `prop_id` = #{propId} AND `is_deleted` = 0
  </select>

  <select id="countPropsQuantity" resultType="com.uxiangtech.activitybox.data.prop.PropIdQuantity">
    SELECT `prop_id`, SUM(`quantity`)
    FROM `t_prop_user`
    WHERE `user_id` = #{userId} AND `activity_id` = #{activityId} AND `prop_id` IN
    <foreach collection="propIds" item="propId" open="(" separator="," close=")">
      #{propId}
    </foreach> AND `is_deleted` = 0
  </select>

  <select id="countAllPropsQuantity" resultType="com.uxiangtech.activitybox.data.prop.PropIdQuantity">
    SELECT `prop_id`, SUM(`quantity`)
    FROM `t_prop_user`
    WHERE `user_id` = #{userId} AND `activity_id` = #{activityId} AND `is_deleted` = 0
  </select>




</mapper>
